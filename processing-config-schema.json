{
  "type": "object",
  "x-display": "tabs",
  "required": ["dataset", "fields", "label", "filename"],
  "allOf": [
    {
      "title": "Jeu de données",
      "properties": {
        "dataset": {
          "type": "object",
          "title": "Jeu de donnée existant",
          "x-fromUrl": "{context.dataFairUrl}/api/v1/datasets?q={q}&select=id,title&{context.ownerFilter}",
          "x-itemsProp": "results",
          "x-itemTitle": "title",
          "x-itemKey": "id",
          "properties": {
            "id": { "type": "string", "title": "Identifiant" },
            "href": { "type": "string", "title": "url" },
            "title": { "type": "string", "title": "Titre" }
          }
        }
      }
    },
    {
      "title": "Paramètres",
      "properties": {
        "fields": {
          "type": "array",
          "title": "Colonnes du jeu de données",
          "x-fromUrl": "{config.dataset.href}/schema?calculated=false",
          "x-itemTitle": "label",
          "x-itemKey": "key",
          "items": {
            "type": "object",
            "properties": {
              "key": { "type": "string" },
              "label": { "type": "string" },
              "type": { "type": "string" }
            }
          },
          "default": []
        },
        "format": {
          "type": "array",
          "title": "Format de sortie des fichiers",
          "description": "Selectionner plusieurs format pour générer plusieurs fichiers",
          "items": {
            "type": "string",
            "enum": [
              "csv",
              "parquet",
              "xlsx",
              "geojson",
              "pmtiles",
              "shz",
              "gpkg"
            ]
          },
          "default": ["csv"]
        },
        "filename": {
          "type": "string",
          "title": "Nom du fichier (sans l'extension)",
          "default": "export"
        },
        "label": {
          "type": "string",
          "title": "Libellé de la pièce jointe",
          "default": "Export"
        },
        "filters": {
          "$ref": "#/definitions/filters"
        }
      }
    }
  ],
  "definitions": {
    "filters": {
      "title": "Filtres prédéfinis",
      "type": "array",
      "items": {
        "type": "object",
        "default": {
          "type": "in"
        },
        "required": ["type"],
        "oneOf": [
          {
            "title": "Restreindre à des valeurs",
            "required": ["field"],
            "properties": {
              "type": {
                "const": "in"
              },
              "field": {
                "$ref": "#/definitions/filterField"
              },
              "values": {
                "type": "array",
                "title": "Valeurs",
                "items": {
                  "type": "string"
                },
                "x-fromUrl": "{config.dataset.href}/values/{parent.value.field.key}?q={q}&q_mode=complete&size=100&stringify=true"
              }
            }
          },
          {
            "title": "Restreindre à un interval de valeurs",
            "required": ["field"],
            "properties": {
              "type": {
                "const": "interval"
              },
              "field": {
                "$ref": "#/definitions/filterField"
              },
              "minValue": {
                "type": "string",
                "title": "Valeur min",
                "x-fromUrl": "{config.dataset.href}/values_agg?field={parent.value.field.key}&sort={parent.value.field.key}&{parent.value.field.key}_gte={q}&stringify=true",
                "x-itemsProp": "aggs",
                "x-itemTitle": "value",
                "x-itemKey": "value"
              },
              "maxValue": {
                "type": "string",
                "title": "Valeur max",
                "x-fromUrl": "{config.dataset.href}/values_agg?field={parent.value.field.key}&sort=-{parent.value.field.key}&{parent.value.field.key}_lte={q}&stringify=true",
                "x-itemsProp": "aggs",
                "x-itemTitle": "value",
                "x-itemKey": "value"
              }
            }
          },
          {
            "title": "Exclure des valeurs",
            "required": ["field"],
            "properties": {
              "type": {
                "const": "out"
              },
              "field": {
                "$ref": "#/definitions/filterField"
              },
              "values": {
                "type": "array",
                "title": "Valeurs à exclure",
                "items": {
                  "type": "string"
                },
                "x-fromUrl": "{config.dataset.href}/values/{parent.value.field.key}?q={q}&q_mode=complete&size=100&stringify=true"
              }
            }
          }
        ]
      }
    },
    "filterField": {
      "type": "object",
      "title": "Colonne de filtre",
      "x-fromUrl": "{config.dataset.href}/schema?calculated=false",
      "x-itemTitle": "label",
      "x-itemKey": "key"
    }
  }
}
